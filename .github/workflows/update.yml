name: update

on:
    push:
        branches:
            - main
    workflow_dispatch:

permissions: write-all

jobs:
    update:
        runs-on: ubuntu-latest

        steps:
            -   uses: actions/checkout@v6

            -   uses: shivammathur/setup-php@v2
                with:
                    php-version: '8.4'
                    extensions: curl, mbstring, zip, pcntl, pdo, pdo_sqlite, iconv, json
                    coverage: none

            -   name: Install Composer dependencies
                run: composer update --prefer-stable --prefer-dist --no-progress --no-interaction

            -   name: Update data
                id: data
                run: composer collect

            -   name: Create a Pull Request
                uses: peter-evans/create-pull-request@v8
                id: pullRequest
                with:
                    branch: projects/download
                    branch-suffix: random
                    delete-branch: true
                    add-paths: ./data
                    title: "[source]: Data updated"
                    commit-message: ðŸ“¦ Data updated
                    body: ðŸ“¦ Data updated
                    labels: |
                        source

            -   name: Merge PR
                if: ${{ steps.pullRequest.outputs.pull-request-number }}
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                run: gh pr merge --merge --auto ${{ steps.pullRequest.outputs.pull-request-number }}
